<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temple de la Gloire - FaritanyX</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>

.holder-avatar {
        width: 40px;
        height: 40px;
        background-color: #565681;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        margin-right: 15px;
        overflow: hidden;
    }

    .holder-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .achiever-avatar {
        width: 30px;
        height: 30px;
        background-color: #565681;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        margin-right: 10px;
        overflow: hidden;
    }
    
    .achiever-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .achiever-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
        .section-title {
    color: #ffcc00;
    text-align: center;
    margin: 40px 0 20px 0;
    font-size: 28px;
    text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
}

.achievements-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.achievement-card {
    background: linear-gradient(135deg, #1f1f35 0%, #2a2a45 100%);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
}

.achievement-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
}

.achievement-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.achievement-icon {
    font-size: 28px;
    margin-right: 15px;
}

.achievement-info {
    flex-grow: 1;
}

.achievement-name {
    font-size: 22px;
    font-weight: bold;
    color: #fff;
}

.achievement-desc {
    color: #bbb;
    font-size: 14px;
    margin-top: 3px;
}

.achievers-list {
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 10px;
    max-height: 200px;
    overflow-y: auto;
}

.achievers-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.achiever-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.achiever-name {
    font-weight: bold;
    color: #fff;
}

.achievement-date {
    font-size: 12px;
    color: #aaa;
}

.no-achievers {
    color: #888;
    font-style: italic;
    text-align: center;
    padding: 15px 0;
}

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #0f0f1a;
            color: #f0f0f0;
            min-height: 100vh;
        }

        .temple-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .temple-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .temple-header h1 {
            font-size: 36px;
            color: #ffcc00;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .temple-header p {
            font-size: 18px;
            color: #aaa;
            max-width: 600px;
            margin: 0 auto;
        }

        .titles-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .title-card {
            background: linear-gradient(135deg, #1f1f35 0%, #2a2a45 100%);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .title-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .title-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .title-icon {
            font-size: 32px;
            margin-right: 15px;
        }

        .title-name {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        .title-description {
            color: #bbb;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .title-holder {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .holder-avatar {
            width: 40px;
            height: 40px;
            background-color: #565681;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }

        .holder-info {
            flex-grow: 1;
        }

        .holder-name {
            font-weight: bold;
            font-size: 18px;
            color: #ffcc00;
        }

        .holder-since {
            font-size: 12px;
            color: #aaa;
            margin-top: 3px;
        }

        .holder-duration {
            font-size: 14px;
            color: #7fe6ff;
        }

        .no-holder {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .history-section {
            background: linear-gradient(135deg, #1f1f35 0%, #2a2a45 100%);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .history-section h2 {
            color: #ffcc00;
            margin-bottom: 20px;
            text-align: center;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }

        .history-title-icon {
            font-size: 24px;
            margin-right: 15px;
            min-width: 24px;
        }

        .history-details {
            flex-grow: 1;
        }

        .history-text {
            margin-bottom: 5px;
        }

        .history-date {
            font-size: 12px;
            color: #aaa;
        }

        .back-button {
            display: inline-block;
            background-color: #2a2a45;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        .back-button:hover {
            background-color: #3a3a55;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #ffcc00;
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .temple-header h1 {
                font-size: 28px;
            }
            
            .temple-header p {
                font-size: 16px;
            }
            
            .title-card {
                padding: 15px;
            }
            
            .title-icon {
                font-size: 28px;
            }
            
            .title-name {
                font-size: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="temple-container">
        <div class="temple-header">
            <h1>Temple de la Gloire</h1>
            <p>Ces guerriers légendaires ont prouvé leur valeur et conquis les titres les plus prestigieux. Leur nom résonne dans la mémoire de Faritany.</p>
        </div>

        <div id="loadingContainer" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Chargement des légendes...</p>
        </div>

        <!-- Section pour les titres limités -->
        <h2 class="section-title">Titres de Prestige</h2>
        <div id="titlesContainer" class="titles-section" style="display: none;">
            <!-- Les cartes de titre seront ajoutées ici dynamiquement -->
        </div>

        <!-- Nouvelle section pour les Exploits de combat -->
        <h2 class="section-title">Exploits de Combat</h2>
        <div id="exploitsContainer" class="achievements-section" style="display: none;">
            <!-- Les exploits seront ajoutés ici dynamiquement -->
        </div>

        <!-- Nouvelle section pour les Conquêtes -->
        <h2 class="section-title">Conquêtes</h2>
        <div id="conquestsContainer" class="achievements-section" style="display: none;">
            <!-- Les conquêtes seront ajoutées ici dynamiquement -->
        </div>

        <div id="historyContainer" class="history-section" style="display: none;">
            <h2>Chroniques des Conquêtes</h2>
            <div id="historyList" class="history-list">
                <!-- L'historique des transferts sera ajouté ici dynamiquement -->
            </div>
        </div>

        <a href="/accueil" class="back-button">Retour à l'accueil</a>
    </div>

    <script>
        const socket = io();
        let currentUsername = '';

        // Fonction pour formater la durée (jours, heures, minutes)
        function formatDuration(startDate) {
            const start = new Date(startDate);
            const now = new Date();
            const diff = now - start;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            let result = '';
            if (days > 0) result += `${days} jour${days > 1 ? 's' : ''} `;
            if (hours > 0 || days > 0) result += `${hours} heure${hours > 1 ? 's' : ''} `;
            result += `${minutes} minute${minutes > 1 ? 's' : ''}`;
            
            return result;
        }

        // Fonction pour formater la date
        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Fonction pour échapper les caractères HTML
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Fonction pour créer un avatar avec possibilité d'image
    function createAvatar(username, size = 'normal') {
        const avatarClass = size === 'small' ? 'achiever-avatar' : 'holder-avatar';
        const fontSize = size === 'small' ? '14px' : '20px';
        
        const avatarElement = document.createElement('div');
        avatarElement.className = avatarClass;
        
        // Créer l'élément d'initiale
        const initialElement = document.createElement('span');
        initialElement.textContent = username.charAt(0).toUpperCase();
        initialElement.style.fontSize = fontSize;
        avatarElement.appendChild(initialElement);
        
        // Tenter de charger la photo de profil
        fetch(`/api/profile-photo/${username}`)
            .then(response => {
                if (response.ok) return response.blob();
                throw new Error('No photo');
            })
            .then(blob => {
                // Remplacer l'initiale par l'image
                avatarElement.innerHTML = '';
                const imgElement = document.createElement('img');
                imgElement.src = URL.createObjectURL(blob);
                imgElement.alt = username;
                avatarElement.appendChild(imgElement);
            })
            .catch(() => {
                // L'initiale reste affichée si pas de photo
            });
        
        return avatarElement;
    }

    // Modifier la fonction updateTitleHolders
    function updateTitleHolders(holders) {
        const container = document.getElementById('titlesContainer');
        container.innerHTML = '';

        // Définir l'ordre des titres
        const titleOrder = ['konungr', 'jarl', 'berserker', 'einherjar'];
        
        // Créer un objet avec les descriptions des titres
        const titleDescriptions = {
            'konungr': 'Le rang suprême, accessible uniquement aux Jarls qui se sont élevés au-dessus de leurs pairs. Seul un Jarl actuel ayant atteint un ELO de 1800+ et obtenu les distinctions Hersir, Drengr, Skald, Ulfhednar et Hirdman peut prétendre à ce titre unique.',
            'jarl': 'Les Jarls sont les stratèges d\'élite ayant atteint un ELO de 1400+ et possédant les distinctions Drengr et Skald. Seuls 4 guerriers peuvent atteindre ce rang, et seuls les Jarls peuvent aspirer au titre de Konungr.',
            'berserker': 'Guerriers redoutables ayant enchaîné 10 victoires consécutives et obtenu la distinction Thegn. Limité à 10 détenteurs.',
            'einherjar': 'Les élus de la bataille, qui ont remporté 5 victoires consécutives. Seuls 20 guerriers peuvent rejoindre leurs rangs.'
        };
        
        // Créer les cartes pour chaque type de titre dans l'ordre
        titleOrder.forEach(titleCode => {
            const titleHolders = holders.filter(h => h.achievement_code === titleCode);
            const titleData = getTitleData(titleCode);
            
            const card = document.createElement('div');
            card.className = 'title-card';
            
            // Créer l'en-tête de la carte
            let cardContent = `
                <div class="title-header">
                    <div class="title-icon">${titleData.icon}</div>
                    <div class="title-name">${titleData.name}</div>
                </div>
                <div class="title-description">${titleDescriptions[titleCode]}</div>
            `;
            
            // Ajouter les détenteurs ou message si aucun
            if (titleHolders.length === 0) {
                cardContent += `<div class="no-holder">Aucun détenteur actuel</div>`;
            } else {
                // Conteneur pour les détenteurs
                const holdersContainer = document.createElement('div');
                
                titleHolders.forEach(holder => {
                    const holderItem = document.createElement('div');
                    holderItem.className = 'title-holder';
                    
                    // Créer l'avatar avec possibilité d'image
                    const avatarElement = createAvatar(holder.username);
                    
                    // Créer l'élément d'information
                    const infoElement = document.createElement('div');
                    infoElement.className = 'holder-info';
                    infoElement.innerHTML = `
                        <div class="holder-name">${escapeHtml(holder.username)}</div>
                        <div class="holder-since">Depuis le ${formatDate(holder.earned_at)}</div>
                    `;
                    
                    // Créer l'élément de durée
                    const durationElement = document.createElement('div');
                    durationElement.className = 'holder-duration';
                    durationElement.textContent = formatDuration(holder.earned_at);
                    
                    // Assembler l'élément détenteur
                    holderItem.appendChild(avatarElement);
                    holderItem.appendChild(infoElement);
                    holderItem.appendChild(durationElement);
                    
                    holdersContainer.appendChild(holderItem);
                });
                
                card.appendChild(holdersContainer);
            }
            
            card.innerHTML = cardContent;
            container.appendChild(card);
        });
        
        document.getElementById('loadingContainer').style.display = 'none';
        container.style.display = 'grid';
    }

    // Modifier la fonction updateExploits
    function updateExploits(achievements) {
        const container = document.getElementById('exploitsContainer');
        container.innerHTML = '';
        
        // Définir les exploits à afficher
        const exploits = [
            { code: 'skald', name: 'Skald', icon: '📜', description: '50 parties jouées' },
            { code: 'thegn', name: 'Thegn', icon: '🛡️', description: '5 victoires contre joueurs ELO 1300+' },
            { code: 'drengr', name: 'Drengr', icon: '⚡', description: 'Victoire contre joueur ELO 1600+' },
            { code: 'hersir', name: 'Hersir', icon: '🪶', description: 'Victoire contre 10 joueurs différents' }
        ];
        
        // Créer une carte pour chaque type d'exploit
        for (const exploit of exploits) {
            const achievers = achievements.filter(a => a.achievement_code === exploit.code);
            
            const card = document.createElement('div');
            card.className = 'achievement-card';
            
            let cardContent = `
                <div class="achievement-header">
                    <div class="achievement-icon">${exploit.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${exploit.name}</div>
                        <div class="achievement-desc">${exploit.description}</div>
                    </div>
                </div>
                <div class="achievers-list">
            `;
            
            if (achievers.length === 0) {
                cardContent += `<div class="no-achievers">Aucun détenteur</div>`;
            } else {
                cardContent += `<ul>`;
                
                // Créer un élément de liste pour chaque détenteur
                const achieversList = document.createElement('ul');
                achieversList.style.padding = '0';
                achieversList.style.margin = '0';
                achieversList.style.listStyle = 'none';
                
                achievers.forEach(achiever => {
                    const achieverItem = document.createElement('li');
                    achieverItem.className = 'achiever-item';
                    
                    // Créer l'avatar
                    const avatarElement = createAvatar(achiever.username, 'small');
                    
                    // Créer les infos
                    const infoElement = document.createElement('div');
                    infoElement.style.display = 'flex';
                    infoElement.style.justifyContent = 'space-between';
                    infoElement.style.width = '100%';
                    infoElement.innerHTML = `
                        <span class="achiever-name">${escapeHtml(achiever.username)}</span>
                        <span class="achievement-date">${formatDate(achiever.earned_at)}</span>
                    `;
                    
                    // Assembler l'élément
                    achieverItem.appendChild(avatarElement);
                    achieverItem.appendChild(infoElement);
                    achieversList.appendChild(achieverItem);
                });
                
                card.innerHTML = cardContent;
                const achieversListContainer = card.querySelector('.achievers-list');
                achieversListContainer.appendChild(achieversList);
            }
            
            if (cardContent.includes('no-achievers')) {
                card.innerHTML = cardContent + '</div>';
            }
            
            container.appendChild(card);
        }
        
        container.style.display = 'grid';
    }

    // Répéter le même processus pour la fonction updateConquests avec les mêmes modifications
    function updateConquests(achievements) {
        const container = document.getElementById('conquestsContainer');
        container.innerHTML = '';
        
        // Définir les conquêtes à afficher
        const conquests = [
            { code: 'ulfhednar', name: 'Ulfhednar', icon: '🐺', description: '3 victoires en moins de 24h' },
            { code: 'hirdman', name: 'Hirdman', icon: '🏹', description: '3 victoires par mise à terre' }
        ];
        
        // Créer une carte pour chaque type de conquête
        for (const conquest of conquests) {
            const achievers = achievements.filter(a => a.achievement_code === conquest.code);
            
            const card = document.createElement('div');
            card.className = 'achievement-card';
            
            let cardContent = `
                <div class="achievement-header">
                    <div class="achievement-icon">${conquest.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${conquest.name}</div>
                        <div class="achievement-desc">${conquest.description}</div>
                    </div>
                </div>
                <div class="achievers-list">
            `;
            
            if (achievers.length === 0) {
                cardContent += `<div class="no-achievers">Aucun détenteur</div>`;
            } else {
                cardContent += `<ul>`;
                
                // Créer un élément de liste pour chaque détenteur
                const achieversList = document.createElement('ul');
                achieversList.style.padding = '0';
                achieversList.style.margin = '0';
                achieversList.style.listStyle = 'none';
                
                achievers.forEach(achiever => {
                    const achieverItem = document.createElement('li');
                    achieverItem.className = 'achiever-item';
                    
                    // Créer l'avatar
                    const avatarElement = createAvatar(achiever.username, 'small');
                    
                    // Créer les infos
                    const infoElement = document.createElement('div');
                    infoElement.style.display = 'flex';
                    infoElement.style.justifyContent = 'space-between';
                    infoElement.style.width = '100%';
                    infoElement.innerHTML = `
                        <span class="achiever-name">${escapeHtml(achiever.username)}</span>
                        <span class="achievement-date">${formatDate(achiever.earned_at)}</span>
                    `;
                    
                    // Assembler l'élément
                    achieverItem.appendChild(avatarElement);
                    achieverItem.appendChild(infoElement);
                    achieversList.appendChild(achieverItem);
                });
                
                card.innerHTML = cardContent;
                const achieversListContainer = card.querySelector('.achievers-list');
                achieversListContainer.appendChild(achieversList);
            }
            
            if (cardContent.includes('no-achievers')) {
                card.innerHTML = cardContent + '</div>';
            }
            
            container.appendChild(card);
        }
        
        container.style.display = 'grid';
    }

        // Mettre à jour l'historique des transferts de titre
        function updateTitleHistory(transfers) {
            const container = document.getElementById('historyList');
            container.innerHTML = '';

            if (transfers.length === 0) {
                container.innerHTML = '<div class="no-holder">Aucun transfert récent</div>';
                return;
            }

            transfers.forEach(transfer => {
                const titleData = getTitleData(transfer.achievement_code);
                
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-title-icon">${titleData.icon}</div>
                    <div class="history-details">
                        <div class="history-text">
                            <strong>${escapeHtml(transfer.to_username)}</strong> a conquis le titre
                            <strong>${titleData.name}</strong> en battant
                            <strong>${escapeHtml(transfer.from_username)}</strong>
                        </div>
                        <div class="history-date">${formatDate(transfer.transferred_at)}</div>
                    </div>
                `;
                
                container.appendChild(item);
            });
            
            document.getElementById('historyContainer').style.display = 'block';
        }

        // Obtenir les détails d'un titre à partir de son code
        function getTitleData(titleCode) {
            const titles = {
                'konungr': { name: 'Konungr', icon: '🏆', maxHolders: 1 },
                'jarl': { name: 'Jarl', icon: '👑', maxHolders: 4 },
                'berserker': { name: 'Berserker', icon: '🪓', maxHolders: 10 },
                'einherjar': { name: 'Einherjar', icon: '⚔️', maxHolders: 20 }
            };
            
            return titles[titleCode] || { name: titleCode, icon: '🏅', maxHolders: 0 };
        }

       // Au chargement de la page
       document.addEventListener('DOMContentLoaded', function() {
            // Récupérer l'utilisateur actuel
            fetch('/check-session')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        currentUsername = data.username;
                    } else {
                        window.location.href = '/login';
                    }
                })
                .catch(error => console.error('Erreur:', error));
            
            // Charger les détenteurs de titres limités
            fetch('/api/title-holders')
                .then(response => response.json())
                .then(data => {
                    updateTitleHolders(data);
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des titres:', error);
                    document.getElementById('loadingContainer').innerHTML = `
                        <p>Erreur lors du chargement des données</p>
                        <button onclick="window.location.reload()">Réessayer</button>
                    `;
                });
            
            // Charger les distinctions pour les exploits de combat
            fetch('/api/achievement-holders?category=exploits')
                .then(response => response.json())
                .then(data => {
                    updateExploits(data);
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des exploits:', error);
                });
            
            // Charger les distinctions pour les conquêtes
            fetch('/api/achievement-holders?category=conquests')
                .then(response => response.json())
                .then(data => {
                    updateConquests(data);
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des conquêtes:', error);
                });
            
            // Charger l'historique des transferts
            fetch('/api/title-transfers/history')
                .then(response => response.json())
                .then(data => {
                    updateTitleHistory(data);
                })
                .catch(error => {
                    console.error('Erreur lors du chargement de l\'historique:', error);
                });
        });

        // Écouter les transferts de titre en temps réel
        socket.on('titleTransferred', function(data) {
            // Recharger les données après un transfert
            fetch('/api/title-holders')
                .then(response => response.json())
                .then(data => {
                    updateTitleHolders(data);
                })
                .catch(error => console.error('Erreur:', error));
            
            fetch('/api/title-transfers/history')
                .then(response => response.json())
                .then(data => {
                    updateTitleHistory(data);
                })
                .catch(error => console.error('Erreur:', error));
        });
    </script>
</body>

</html>